name: Deploy to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pre-deployment validation
        run: |
          echo "ğŸ” Validating repository structure for deployment..."
          echo "ğŸ“ HTML files to deploy:"
          ls -la *.html | head -10
          echo ""
          echo "ğŸ“¦ Total HTML files: $(ls -1 *.html | wc -l)"
          echo "ğŸ“Š Repository size: $(du -sh . | cut -f1)"
          echo "âœ… Repository structure validated"

      - name: Setup Pages
        uses: actions/configure-pages@v4
        continue-on-error: true
        id: pages-setup

      - name: Handle Pages configuration
        run: |
          if [ "${{ steps.pages-setup.outcome }}" != "success" ]; then
            echo "âŒ GitHub Pages configuration failed!"
            echo ""
            echo "ğŸ”§ To fix this issue, please:"
            echo "1. Go to repository Settings â†’ Pages"
            echo "2. Set Source to 'GitHub Actions'"
            echo "3. Re-run this workflow"
            echo ""
            echo "ğŸ“– More info: https://docs.github.com/en/pages/getting-started-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site#publishing-with-a-custom-github-actions-workflow"
            exit 1
          else
            echo "âœ… GitHub Pages configured successfully"
          fi

      - name: Prepare deployment
        run: |
          echo "ğŸš€ Preparing deployment at $(date -u)"
          echo "ğŸ“ Final validation before deployment:"
          echo "- Index file: $([ -f index.html ] && echo "âœ… Found" || echo "âŒ Missing")"
          echo "- CSS files: $(find css -name "*.css" 2>/dev/null | wc -l) files found"
          echo "- JS files: $(find js -name "*.js" 2>/dev/null | wc -l) files found"
          echo "- Arabic content check: $(grep -l "Ø§Ù„ÙØ§Ø±Ø³" *.html | wc -l) Arabic pages found"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Post-deployment
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ”„ Changes should be visible within a few minutes"
          echo "â° Deployed at: $(date -u)"